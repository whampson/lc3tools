#include <stdint.h>
#include <stdio.h>

#include <lc3.h>

struct micro_ctl {
    uint16_t ird    : 1;
    uint16_t cond   : 3;
    uint16_t j      : 6;
};

/* Unused: 26, 46, 53, 55, 57, 61, 63 */
static const struct micro_ctl ctl_rom[] = {
    { 0, 0x02, 18 }, { 0, 0x00, 18 }, { 0, 0x00, 29 }, { 0, 0x00, 24 }, /*  0-3  */
    { 0, 0x03, 20 }, { 0, 0x00, 18 }, { 0, 0x00, 25 }, { 0, 0x00, 23 }, /*  4-7  */
    { 0, 0x04, 36 }, { 0, 0x00, 18 }, { 0, 0x00, 56 }, { 0, 0x00, 60 }, /*  8-11 */
    { 0, 0x00, 18 }, { 0, 0x00, 18 }, { 0, 0x00, 18 }, { 0, 0x00, 28 }, /* 12-15 */
    { 0, 0x00, 18 }, { 0, 0x01, 17 }, { 0, 0x05, 33 }, { 0, 0x05, 33 }, /* 16-19 */
    { 0, 0x00, 18 }, { 0, 0x00, 18 }, { 0, 0x00, 18 }, { 0, 0x00, 16 }, /* 20-23 */
    { 0, 0x00, 17 }, { 0, 0x01, 25 }, { 0, 0x00, 00 }, { 0, 0x00, 18 }, /* 24-27 */
    { 0, 0x01, 28 }, { 0, 0x01, 29 }, { 0, 0x00, 18 }, { 0, 0x00, 18 }, /* 28-31 */
    { 1, 0x00, 00 }, { 0, 0x01, 33 }, { 0, 0x04, 51 }, { 0, 0x00, 32 }, /* 32-35 */
    { 0, 0x01, 36 }, { 0, 0x00, 41 }, { 0, 0x00, 39 }, { 0, 0x00, 40 }, /* 36-39 */
    { 0, 0x01, 40 }, { 0, 0x01, 41 }, { 0, 0x00, 34 }, { 0, 0x00, 47 }, /* 40-43 */
    { 0, 0x00, 45 }, { 0, 0x00, 37 }, { 0, 0x00, 00 }, { 0, 0x00, 48 }, /* 44-47 */
    { 0, 0x01, 48 }, { 0, 0x04, 37 }, { 0, 0x00, 52 }, { 0, 0x00, 18 }, /* 48-51 */
    { 0, 0x01, 52 }, { 0, 0x00, 00 }, { 0, 0x00, 18 }, { 0, 0x00, 00 }, /* 52-55 */
    { 0, 0x01, 56 }, { 0, 0x00, 00 }, { 0, 0x00, 25 }, { 0, 0x00, 18 }, /* 56-59 */
    { 0, 0x01, 60 }, { 0, 0x00, 00 }, { 0, 0x00, 23 }, { 0, 0x00, 00 }  /* 60-63 */
};

int next_state(int state, int op, int ir11, int r, int ben, int psr15, int intf)
{
    int next;
    struct micro_ctl ctl;

    ctl = ctl_rom[state];
    if (ctl.ird) {
        next = op;
        goto done;
    }

    next = ctl.j;
    if (r && ctl.cond == 0x01) {
        next |= 0x02;
    }
    if (ben && ctl.cond == 0x02) {
        next |= 0x04;
    }
    if (ir11 && ctl.cond == 0x03) {
        next |= 0x01;
    }
    if (psr15 && ctl.cond == 0x04) {
        next |= 0x08;
    }
    if (intf && ctl.cond == 0x05) {
        next |= 0x10;
    }

done:
    return next;
}
